name: Build ExynosTools v1.3.1 (ARM64 Android)

on:
  workflow_dispatch:
  push:
    branches: [ main, v1.3.1 ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Debug environment
        run: |
          echo "Runner OS: $RUNNER_OS"
          echo "Home: $HOME"
          echo "Shell: $SHELL"
          uname -a
          gcc --version || echo "GCC not found"
          cmake --version || echo "CMake not found"

      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install minimal dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake ninja-build pkg-config
          sudo apt install -y libdrm-dev libexpat1-dev libelf-dev flex bison python3-mako
          sudo apt install -y glslang-tools spirv-tools

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Download Vulkan Headers
        run: |
          git clone --depth 1 https://github.com/KhronosGroup/Vulkan-Headers.git vulkan-headers
          sudo cp -r vulkan-headers/include/* /usr/local/include/

      - name: Clone Mesa Base (if needed for Exynos patches)
        run: |
          git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git mesa || echo "Mesa already exists"

      - name: Configure CMake (Android ARM64)
        run: |
          export ANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }}
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DVULKAN=ON \
            -Dgallium-drivers=turnip \
            -Dvulkan-drivers=exynos \
            -Dplatforms= \
            -Dbuild-tests=OFF \
            -Dllvm=OFF \
            -G Ninja \
          || (echo "CMake config failed - check source/CMakeLists.txt"; exit 1)

      - name: Build
        run: |
          cd build
          ninja -v || (echo "Build failed"; exit 1)

      - name: Package
        run: |
          cd build
          ninja install
          mkdir -p exynostools-1.3.1-arm64/usr/lib64
          find ../install -name "*.so*" | head -10 | xargs -I {} cp {} exynostools-1.3.1-arm64/usr/lib64/
          $ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-strip --strip-unneeded exynostools-1.3.1-arm64/usr/lib64/*.so*
          tar -czf exynostools-1.3.1-arm64.tar.gz exynostools-1.3.1-arm64

      - name: Verify
        run: |
          ls -la exynostools-1.3.1-arm64/usr/lib64/
          file exynostools-1.3.1-arm64/usr/lib64/*.so* || echo "No .so files - build incomplete"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: exynostools-1.3.1-arm64
          path: exynostools-1.3.1-arm64.tar.gz
