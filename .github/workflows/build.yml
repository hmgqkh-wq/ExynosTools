name: build-android-arm64

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      ANDROID_NDK_HOME: ${{ runner.tool_cache }}/android-ndk-r25b
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential cmake ninja-build meson zstd python3-pip make vim-common glslang-tools libvulkan-dev wget

      - name: Install Vulkan SDK (for glslc/glslangValidator)
        run: |
          wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
          sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
          sudo apt update
          sudo apt install -y vulkan-sdk || true

      - name: Setup Android NDK r25b
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25b

      - name: Ensure python3 present
        run: |
          python3 --version
          pip3 --version || sudo apt-get install -y python3-pip

      - name: Generate SPIR-V headers (glslangValidator -> headers)
        run: |
          set -euo pipefail
          OUT_DIR=build-android/generated_spv
          mkdir -p "$OUT_DIR"
          # Update SHADER_SRC_DIR to where your .comp files live in the repo
          SHADER_SRC_DIR=assets/shaders/src
          # expected shader basenames required by bc_emulate.c
          NAMES="bc1 bc2 bc3 bc4 bc5 bc6h bc7"
          for NAME in $NAMES; do
            SRC="$SHADER_SRC_DIR/${NAME}.comp"
            SPV="$OUT_DIR/${NAME}.spv"
            HDR="$OUT_DIR/${NAME}_shader.h"
            if [ -f "$SRC" ]; then
              echo "Compiling shader $SRC -> $SPV"
              glslangValidator -V -o "$SPV" "$SRC"
              python3 scripts/spv_to_header.py "$SPV" "$HDR" "${NAME}_shader"
            else
              echo "Missing shader source: $SRC"
              exit 1
            fi
          done

      - name: Configure (CMake Android arm64 with ray tracing)
        run: |
          cmake -S . -B build-android \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=31 \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_STL=c++_shared \
            -DCMAKE_C_FLAGS="-I$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include" \
            -DCMAKE_VERBOSE_MAKEFILE=ON \
            -DVK_USE_PLATFORM_ANDROID_KHR=ON \
            -DENABLE_RAY_TRACING=ON \
            -DENABLE_VRS=ON

      - name: Build (CMake)
        run: cmake --build build-android --config Release -j

      - name: Install to staging
        run: cmake --install build-android --prefix "$(pwd)/staging"

      - name: Verify size
        run: |
          ls -lh staging/usr/lib/ || echo "No lib directory found"
          sofile=staging/usr/lib/libxeno_wrapper.so
          if [ ! -f "$sofile" ]; then echo "Missing libxeno_wrapper.so"; exit 1; fi
          size=$(stat -c%s "$sofile")
          echo "Size: $size bytes"
          if [ "$size" -lt 80000 ]; then echo "Shared object too small (<80KB)"; exit 1; fi

      - name: Prepare package layout
        run: |
          mkdir -p pkg/usr/lib pkg/usr/share pkg/etc/exynostools pkg/profiles/winlator pkg/assets/shaders/decode
          cp -v staging/usr/lib/libxeno_wrapper.so pkg/usr/lib/ || echo "lib copy failed"
          cp -v usr/share/meta.json pkg/usr/share/ || echo "meta.json copy failed"
          cp -v etc/exynostools/performance_mode.conf pkg/etc/exynostools/ || echo "conf copy failed"
          cp -v profiles/winlator/*.env pkg/profiles/winlator/ || echo "env copy failed"
          if [ -d build-android/generated_spv ]; then
            # include SPIR-V headers (optional) and compiled SPV binaries
            cp -v build-android/generated_spv/*.spv pkg/assets/shaders/decode/ || true
          fi

      - name: Create tar.zst
        run: |
          tar --zstd -cvf exynostools-android-arm64.tar.zst -C pkg .
          echo "Created exynostools-android-arm64.tar.zst"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: exynostools-android-arm64
          path: exynostools-android-arm64.tar.zst
