name: build-android-arm64

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y cmake ninja-build meson zstd python3-pip unzip
          pip3 install meson ninja

      - name: Setup Android NDK r25b
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25b

      - name: Export NDK path
        run: echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      - name: Install glslc from Shaderc v2023.3
        run: |
          wget https://github.com/google/shaderc/releases/download/v2023.3/glslc-linux-x86_64.zip
          unzip glslc-linux-x86_64.zip -d glslc-bin
          echo "${PWD}/glslc-bin" >> $GITHUB_PATH
          echo "GLSLC_EXECUTABLE=${PWD}/glslc-bin/glslc" >> $GITHUB_ENV
          glslc --version

      - name: Configure (CMake Android arm64)
        run: |
          cmake -S . -B build-android -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=31 \
            -DCMAKE_BUILD_TYPE=Release \
            -DGLSLC_EXECUTABLE="${GLSLC_EXECUTABLE}"

      - name: Build (CMake)
        run: cmake --build build-android --config Release -j

      - name: Install to staging
        run: cmake --install build-android --prefix $(pwd)/staging

      - name: Verify size
        run: |
          ls -lh staging/usr/lib/
          sofile=staging/usr/lib/libxeno_wrapper.so
          if [ ! -f "$sofile" ]; then echo "Missing libxeno_wrapper.so"; exit 1; fi
          size=$(stat -c%s "$sofile")
          echo "Size: $size bytes"
          if [ "$size" -lt 80000 ]; then echo "Shared object too small (<80KB)"; exit 1; fi

      - name: Prepare package layout
        run: |
          mkdir -p pkg/usr/lib pkg/usr/share pkg/etc/exynostools pkg/profiles/winlator pkg/assets/shaders/decode
          cp -v staging/usr/lib/libxeno_wrapper.so pkg/usr/lib/
          cp -v usr/share/meta.json pkg/usr/share/
          cp -v etc/exynostools/performance_mode.conf pkg/etc/exynostools/
          cp -v profiles/winlator/*.env pkg/profiles/winlator/
          cp -v assets/shaders/decode/*.spv pkg/assets/shaders/decode/

      - name: Create tar.zst
        run: |
          tar --zstd -cvf exynostools-android-arm64.tar.zst -C pkg .
          echo "Created exynostools-android-arm64.tar.zst"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: exynostools-android-arm64
          path: exynostools-android-arm64.tar.zst
