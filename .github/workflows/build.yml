name: Build ExynosTools Driver

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install build tools
        run: |
          sudo apt update
          sudo apt install -y build-essential meson ninja-build zstd cmake unzip wget
          wget https://github.com/google/shaderc/releases/download/v2023.3/glslc-linux-x86_64.zip
          unzip glslc-linux-x86_64.zip
          sudo mv glslc /usr/bin/

      - name: Configure build
        run: meson setup builddir --prefix=/usr

      - name: Compile driver
        run: ninja -C builddir

      - name: Package for emulator
        run: |
          mkdir -p exynostools-android-arm64/usr/lib
          cp builddir/*.so exynostools-android-arm64/usr/lib/
          tar -cvf exynostools-android-arm64.tar exynostools-android-arm64
          zstd exynostools-android-arm64.tar

      - name: Upload driver archive
        uses: actions/upload-artifact@v3
        with:
          name: exynostools-driver
          path: exynostools-android-arm64.tar.zst
